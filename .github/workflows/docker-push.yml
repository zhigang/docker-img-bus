name: Docker Image Push

on:
  push:
    branches: [main, master]
    paths:
      - "images.txt"
  workflow_dispatch:

jobs:
  push-images:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v2
        with:
          registry: registry.cn-shanghai.aliyuncs.com
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: Read images.txt and push images
        run: |
          # 读取images.txt文件，跳过注释行和空行
          while IFS= read -r line || [ -n "$line" ]; do
            # 跳过注释行和空行
            if [[ $line =~ ^\s*# || -z $line ]]; then
              continue
            fi
            
            echo "Processing image: $line"
            
            # 提取标签，如果没有标签则使用latest
            if [[ $line == *":"* ]]; then
              TAG=$(echo $line | cut -d ':' -f 2)
            else
              TAG="latest"
            fi
            
            # 拉取原始镜像
            docker pull $line
            
            # 提取镜像源地址和名称
            if [[ $line =~ ^([^/]+)/(.+)$ ]]; then
              # 处理带有源地址的镜像，如 k8s.gcr.io/ingress-nginx/controller:v1.12.0
              REGISTRY=${BASH_REMATCH[1]}
              IMAGE_PATH=${BASH_REMATCH[2]}
              
              # 检查是否包含源地址（如 docker.elastic.co）
              if [[ $REGISTRY == *"."* ]]; then
                # 如果有源地址，只使用镜像路径部分
                FORMATTED_NAME=$IMAGE_PATH
              else
                # 没有源地址，保留完整路径
                FORMATTED_NAME="${REGISTRY}-${IMAGE_PATH}"
              fi
              
              # 检查命名空间是否与镜像名相同
              if [[ $FORMATTED_NAME =~ ^([^/]+)/\1(/|$) ]]; then
                # 如果相同，只保留一个
                FORMATTED_NAME=${BASH_REMATCH[1]}
              fi
              
              # 替换斜杠和点号为连字符
              FORMATTED_NAME=$(echo $FORMATTED_NAME | tr '/' '-' | tr '.' '-')
            else
              # 处理普通格式的镜像，如 nginx:1.27.4
              IMAGE_NAME=$line
              
              # 如果有标签，移除标签部分
              if [[ $IMAGE_NAME == *":"* ]]; then
                IMAGE_NAME=$(echo $IMAGE_NAME | cut -d ':' -f 1)
              fi
              
              # 检查命名空间是否与镜像名相同
              if [[ $IMAGE_NAME =~ ^([^/]+)/\1$ ]]; then
                # 如果相同，只保留一个
                IMAGE_NAME=${BASH_REMATCH[1]}
              fi
              
              # 处理包含斜杠的镜像名称，将斜杠替换为连字符
              FORMATTED_NAME=$(echo $IMAGE_NAME | tr '/' '-')
            fi
            
            # 重新标记为阿里云镜像
            TARGET_IMAGE="registry.cn-shanghai.aliyuncs.com/siriuszg/${FORMATTED_NAME}:${TAG}"
            docker tag $line $TARGET_IMAGE
            
            # 推送到阿里云
            echo "Pushing to: $TARGET_IMAGE"
            docker push $TARGET_IMAGE
          done < images.txt
